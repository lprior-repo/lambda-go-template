name: üöÄ Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.23"
  TERRAFORM_VERSION: '1.13.0'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      functions: ${{ steps.changes.outputs.functions }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - name: Detect changed functions
        id: changes
        run: |
          # Get list of all function directories
          FUNCTIONS=$(find src -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n")[:-1]')
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
          echo "Detected functions: $FUNCTIONS"

  build:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        function: ${{ fromJson(needs.detect-changes.outputs.functions) }}

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Set up Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run tests
        run: |
          if [ -f "src/${{ matrix.function }}/main_test.go" ]; then
            cd src/${{ matrix.function }}
            go test -v ./...
          else
            echo "No tests found for ${{ matrix.function }}, skipping"
          fi

      - name: Build function
        run: |
          cd src/${{ matrix.function }}
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="-s -w" -o bootstrap main.go

      - name: Create deployment package
        run: |
          mkdir -p build
          cd src/${{ matrix.function }}
          zip -r ../../build/${{ matrix.function }}.zip bootstrap

      - name: Upload build artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: ${{ matrix.function }}-lambda-go
          path: build/${{ matrix.function }}.zip
          retention-days: 30

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Set up Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules for linting
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-lint-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-lint-
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: golangci-lint
        uses: golangci/golangci-lint-action@4696ba8babb6127d732c3c6dde519db15edab9ea
        with:
          version: v1.62.0
          working-directory: .
          args: --timeout=5m

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Set up Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules for security scan
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-security-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-security-
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Install Gosec
        run: go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest

      - name: Run Gosec Security Scanner
        run: gosec ./...

  # üèóÔ∏è Infrastructure Validation
  infrastructure:
    name: üèóÔ∏è Infrastructure Validation
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: üèóÔ∏è Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: üîß Terraform Init
        working-directory: terraform
        run: terraform init -backend=false

      - name: ‚úÖ Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: üé® Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive

      - name: üîç Setup TFLint
        uses: terraform-linters/setup-tflint@90f302c255ef959cbfb4bd10581afecdb7ece3e6
        with:
          tflint_version: v0.54.0

      - name: üîç Run TFLint
        working-directory: terraform
        run: |
          tflint --init
          tflint --recursive --config=../.tflint.hcl

      - name: üí∞ Infrastructure Cost Estimate
        uses: infracost/actions/setup@27b6d22bb2e4bf1838fbc40e71f6844e784bb049
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: üí∞ Generate Cost Estimate
        run: |
          cd terraform
          infracost breakdown --path . \
            --format json \
            --out-file /tmp/infracost.json
          infracost output --path /tmp/infracost.json \
            --format table \
            --out-file /tmp/infracost.txt

      - name: üí∞ Upload Cost Analysis
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: infrastructure-cost-analysis-go
          path: /tmp/infracost.*
          retention-days: 30